---
SPDX-License-Identifier: MIT
path: "/tutorials/install-and-configure-mailserver-mox-on-debian"
slug: "install-and-configure-mailserver-mox-on-debian"
date: "2024-06-06"
title: "Mox - a secure all-in-one email server"
short_description: "Install Mox - a secure all-in-one email server - with DANE and MTA_STS support on Debian 12"
tags: ["Mailserver", "Mox", "Lang:Go", "Lang:TypeScript", "Debian"]
author: "Robert Bill"
author_link: "https://github.com/RobSlgm"
author_img: "https://avatars.githubusercontent.com/u/147130488?v=4"
author_description: ""
language: "en"
available_languages: ["en"]
header_img: "header-x"
cta: "product"
---

## Introduction

[Mox](https://www.xmox.nl/) is a modern open-source email server. Mox ambition is to replace a classic email server stack consisting of Postfix, Dovecot and Rspamd.

This tutorial shows how to install and configure a fully working email server on a **dedicated VPS** using Debian 12 with emphasis on a working setup featuring [DNSSEC / DANE](https://datatracker.ietf.org/doc/html/rfc7671) and [SMTP MTA Strict Transport Security (MTA_STS)](https://datatracker.ietf.org/doc/html/rfc8461).


**Prerequisites**

We will use `hcloud` to create a **new** virtual server and firewall rules, therefore install on your local machine `hcloud` CLI and obtain a Hetzner Cloud API token. For further help see:

* Hetzner Cloud [API token](https://docs.hetzner.com/cloud/api/getting-started/generating-api-token) in the [Cloud Console](https://console.hetzner.cloud/)
* [SSH key](https://community.hetzner.com/tutorials/howto-ssh-key) for root access

You need a domain, i.e. `example.com`, and be able to add or change DNS records at your registrar or DNS provider.

To access the management UI of Mox a Wireguard network is strongly recommended. The setup of Wireguard is out of scope of this tutorial. You will need further to install Wireguard on your local machine for a direct connection or on your home router for a site-to-site connection.
As alternative you can connect via SSH port re-direction.
For further help see:
* [Wireguard on Debian -> Step 2 - Alternative A - Manual Configuration](https://wiki.debian.org/WireGuard)
* Or a [step-by-step setup of Wireguard](https://www.server-world.info/en/note?os=Debian_12&p=wireguard&f=1)


**Terminology**

Throughout this tutorial following terms will be used.

Your main domain is `example.com`. The name of the mail server will be from this domain. Mail addresses used are `holu@example.com` for a standard user and `postmaster@example.com` as owner of the mail server.

The mail server will use the subdomain `mail.example.com`, the hostname will be <your_host>. Donâ€™t use `mail` as hostname.

This mail server can send and deliver mails for other domain names. We will use `example.org` as name of such a domain and `holu2@example.org` as a user of this mail domain.

The VPS has following IP addresses:
   * Public: `<203.0.113.1>` and `<2001:db8:5678::1>`
   * Private LAN: `<198.51.100.1>` and `<2001:db8:9abc::1>`

For Wireguard port `51820` is used and an the IP's are from `<10.51.0.0>`.

Replace all mentions of these values with your actual values.

## Step 1 - Basic firewall rules

We create a firewall rule set named `mailserver`.

~~~bash
hcloud firewall create --name mailserver --label usage=email
hcloud firewall add-rule mailserver --description "SSH Console Access" --direction in --port 22 --protocol tcp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "ICMP" --direction in --protocol icmp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "Wireguard" --direction in --port 51820 --protocol udp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "HTTPS" --direction in --port 443 --protocol tcp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "Mailbox - IMAP" --direction in --port 993 --protocol tcp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "Mailbox - SMTP Submission" --direction in --port 465 --protocol tcp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall add-rule mailserver --description "Mail - Delivery" --direction in --port 25 --protocol tcp --source-ips "0.0.0.0/0" --source-ips "::/0"
hcloud firewall apply-to-resource mailserver --type label_selector --label-selector usage=email
~~~

Beside the generic rules (SSH, ICMP, Wireguard) the access to the mailbox (IMAP, SMTP submission) is allowed only on TLS ports. POP3 is not supported by Mox.

Change port 51820 for Wireguard according to your setup.

Mail delivery to other mail server is done over port 25. Please be aware, that port 25 is by default blocked on Hetzner. Refer to the [english FAQ](https://docs.hetzner.com/cloud/servers/faq/#why-can-i-not-send-any-mails-from-my-server) or [german FAQ](https://docs.hetzner.com/de/cloud/servers/faq/#warum-kann-ich-keine-mails-von-meinem-server-verschicken).

A website is required by MTA_STS, therefore the HTTPS port must be allowed.

Fail2ban (and the dependency python3-systemd) is only used for the SSH port. The mail ports are protected by Mox directly.
> Optionally: To avoid excess log entries change the default SSH port 25 (e.g. to 20025). You will need to uncomment the Port line for sshd_config in the cloud-init file.


## Step 2 - Create the server

The actual VPS server is configured with a Cloud Init file.

~~~yaml
#cloud-config
hostname: <your_host>
users:
  - name: mox
    groups: users
    shell: /bin/bash
packages:
  - dns-root-data
  - unbound-anchor
  - unbound
  - wireguard
  - jq
  - fail2ban
  - python3-systemd
package_update: true
package_upgrade: true
write_files:
  - path: /etc/ssh/sshd_config.d/10-common.conf
    content: |
      SyslogFacility AUTH
      LogLevel INFO
      PermitRootLogin prohibit-password
      StrictModes yes
      PasswordAuthentication no
      X11Forwarding no
      # Port 20025
  - path: /etc/fail2ban/jail.local
    permissions: "0644"
    content: |
      [DEFAULT]
      ignoreip = 127.0.0.1/8 ::1 198.51.100.0/24 10.51.0.0/16
      backend = systemd
      allowipv6 = auto

      [sshd]
      enabled = true
  - path: /etc/fail2ban/fail2ban.local
    permissions: "0644"
    content: |
      [DEFAULT]
      loglevel = INFO
      logtarget = SYSTEMD-JOURNAL
  - path: /etc/unbound/unbound.conf.d/ede.conf
    permission: "0755"
    content: |
      server:
          ede: yes
          val-log-level: 2
~~~
Store this content locally as `mox.cloud-init.yaml`. Replace in `fail2ban/jail.local` the networks to ignore (in our case Hetzner Private network and Wireguard network).

~~~bash
hcloud server create --type YYY --name <your_host> --image debian-12 --ssh-key my_own_ssh_key_name --location XXX  --firewall mailserver --user-data-from-file mox.cloud-init.yaml --label usage=email
~~~

Choose your own Hetzner location (e.g. --location fsn1) and type (e.g. --type cpx21). For a test installation any type of cloud server will do.

In a first-time setup you will receive new IPv4 and IPv6 primary addresss, e.g. `203.0.113.1` and `2001:db8:5678::1`.

If these primary IP addresses are good (see step 2.1) [you should protect](https://docs.hetzner.com/cloud/servers/primary-ips/faq/#how-do-i-protect-my-primary-ip-from-being-deleted-by-accident) and label it - i.e. `mail-ip4`, `mail-ip6` - in the Hetzner Console UI. A reservation of an IPv4 address can be chargeable.

To re-create the server later with the same IP's use:

~~~bash
hcloud server create --type YYY --name <your_host> --image debian-12 --ssh-key my_own_ssh_key_name --location XXX  --firewall mailserver --user-data-from-file cloud-init.yaml --label usage=email  --primary-ipv4 mail-ip4  --primary-ipv6 mail-ip6
~~~

The location must be the same as on the first run as the IP's are tied to it. The server type can be changed.

A correct reverse DNS setting is in practice required for mail servers:
~~~bash
hcloud server set-rdns --hostname mail.example.com --ip 203.0.113.1 <your_host>
hcloud server set-rdns --hostname mail.example.com --ip 2001:db8:5678::1 <your_host>
~~~


> **Advanced and out-of-scope**: This setup demonstrates the installation of Mox in a basic, but still safe way. Consider hardening the server even more (i.e. root access, local firewall). If you consider a proxy, please be aware that the mail server needs the real IP of the connection.


### Step 2.1 - Reputation of IP addresses

Sending and receiving emails depends on the reputation of your site. DNS blocking lists are used to fight spam mail. They block based on single IP's, IP ranges, domain names and further criterias.

Before you continue, verify that your new IP address does not appear on DNS blocking lists. Use online tools such as https://multirbl.valli.org/lookup. Check primarily your IPv4, but also your IPv6 address.

The IP address should not appear on any block list. You may need to wait for some few hours for the propagation of reverse your RDNS entries.

**Exception**: Some top level domains (e.g. mostly country domains with privacy regulation) are on the https://spfbl.net/en/dnsbl/ block list. This block list requires a email address in the DNS records, which due to regulation are never there... Ignore this list.

If you got a *burned* IP there are three options:
- Check if you can trigger a removal from the block list. The procedures are different for almost each list and not guaranteed to work in every case.
- Park the IP (or use it for no mail related stuff) for some days or weeks, then recheck
- Or create a new server (see statements in previous step) to get a **new IP address** and then delete the first server. Repeat the check.

**Caution**: Do not continue with this tutorial till you have IP's with good reputation.

### Step 2.2 - Basic DNS entries

We will use `mail.example.com` as name for our mail server instance.

Add A and AAAA DNS records for `mail.example.com`. Wait for DNS propagation; check if you are able to ping your hostname from outside.

If you want, add A and AAAA DNS records for the hostname, i.e. `<your_host>.example.com`.

### Step 2.3 - DNSSEC

Our Cloud-init configuration installed unbound with a minimal configuration and adaptions for Mox. Prior to enabling the DNSSEC/DANE setup for the mail server, ensure the functionality of the DNS resolver. There are several requirements to DNSSEC.

Your domain registrar **must support** it for your choosen TLD. Depending on for registrar / DNS provider you need to enable DNSSEC for your domain. Check also that your DNS provider supports DNS records of the type `TLSA`.

> [Hetzner DNS doesn't support DNSSEC](https://docs.hetzner.com/dns-console/dns/general/dnssec/) or [german](https://docs.hetzner.com/dns-console/dns/general/dnssec/).

> Obviously you can use Mox without DNSSEC, DANE or MTA-STS, but the goal of this tutorial is to demostrate a state-of-the-art mail server setup.

Check the basic DNSSEC support with `delv mail.example.com`. The output should be like - here shown with `devl xmox.nl` as example of a signed domain - this:

~~~text
; fully validated
xmox.nl.                3600    IN      A       84.22.96.237
xmox.nl.                3600    IN      RRSIG   A 13 2 3600 20240615023049 20240601022704 58294 xmox.nl. ENE/6GtRyJ95oL7jA9bayaVu2rZpks6kX4tM6kqkiZWHZPUc9/WFwLh9 NU2TMXgOz4rKkOf/WwlMJSnazjfREA==
~~~

An unsigned domain looks like
~~~text
; unsigned answer
hetzner.de.             60      IN      A       213.133.116.44
~~~

For a DANE setup you need the RRSIG DNS record, and your local resolver needs to read the authoritative answer.

`dig mail.example.com` and `dig @127.0.0.1 mail.example.com` should show the same result and in the line with **flags:** 'ad' must appear.

~~~text
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
~~~

Everything works? So now finally to the installation ...


## Step 3 - Mox installation

Connect as root to your VPS and download the latest executable of Mox with

~~~bash
cd /home/mox
wget https://beta.gobuilds.org/github.com/mjl-/mox@latest/linux-amd64-latest/dl -O mox
chmod +x ./mox
~~~

Mox is a single binary file, so that's all.


We use the [`quickstart` command](https://www.xmox.nl/commands/) to generate the setup

~~~bash
su - mox
./mox quickstart postmaster@example.com
exit
~~~

Capture the output of `mox quickstart` for future reference.
It contains the initial admin and postmaster password, which you can change at any time with `mox setadminpassword` on the console.


## Step 3.1 - Full DNS setup of main mail domain

The output of the `mox quickstart` also contains the required DNS records.
Add these records at your DNS provider/registrar.

We will need all the documented DNS entries.

The DNS DKIM must be added as a single TXT record (as mentioned in the quickstart output). Remove spaces and quotes, the record must start with `v=DKIM1...`

After you have done this tedious step, check again if DNSSEC/DANE works, with
~~~bash
dig +dnssec +noall +answer +multi _25._tcp.mail.example.com. TLSA
~~~

The output should be similar to this:
~~~bash
_25._tcp.mail.example.com.   3600 IN TLSA 3 1 1 (
                                DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
                                BBBBBBBBBBBBBBB )
_25._tcp.mail.example.com.   3600 IN TLSA 3 1 1 (
                                78888888888888888888888888888888888888888888
                                999999999999999 )
_25._tcp.mail.example.com.   3600 IN RRSIG TLSA 13 5 3600 (
                                20240901153149 20240121141946 48145 example.com.
                                wzkdfajkfjajsdflkjasdlfkjasdlfkjasldfjlasdfj
                                askjfdaklsdjflkasdjfklasdfjlkasdjfQQQQQQ )
~~~

Otherwise check your DNS entries and / or wait for DNS propagation.

## Step 3.2 - Mox configuration

Change or check in `mox.conf` (e.g. with `nano /home/mox/config/mox.conf`) following values:

- `Listeners -> internal -> IPs`: should only contain private IP addresses (Localhost, Hetzner private LAN, Wireguard)

- `Listeners -> public -> IPs`: should contain two lines with the public IPv4 and IPv6 address

- `Listeners -> public -> WebserverHTTP`: Set Enabled to false (change it back later if you use this functionalty)

- `Listeners -> public -> WebserverHTTPS`: Set Enabled to false (change it back later if you use this functionalty)

- `CheckUpdates`: Enable to stay up to date (optional).


## Step 3.3 - Mox as a service

Again as root, execute these steps

~~~bash
cd /home/mox
systemctl enable $PWD/mox.service
systemctl start mox.service
systemctl status mox.service
~~~

Verify that no error is shown in the status report.

## Step 3.3 - Mox admin UI

Over WG network use http://198.51.100.1/admin/ or redirect over SSH http://localhost:8080/admin/ to access the admin page. The instructions to use SSH port redirections instead of a Wireguard VPN are contained in the quickstart output.

Go to Mox Admin -> Domain example.com -> Check DNS records.

All entries must be green (MTA-STS with a MaxAge less than 1 day is during testing no issue, **MUST** be changed later for production use).

Use the admin pages to create accounts and mailboxes or use the CLI, i.e.

~~~bash
cd /home/mox
./mox config account add holu holu@example.com
./mox config address add admin@example.com holu
./mox config alias add info@example.com holu@example.com
./mox setaccountpassword holu
~~~



## Step 4 - Day 2 operations

### Mail client setup - Thunderbird

Using Thunderbird as mail client demonstrates the auto config setup.
Add new mail account with `holu@example.com` and all options should be auto detected by Thunderbird, otherwise refer to the output of the quickstart.

~~~text
When configuring your email client, use the email address as username. If
autoconfig/autodiscover does not work, use these settings:
Protocol             Host                            Port Listener        Note
Submission (SMTP)    mail.example.com                     465 public          with TLS
IMAP                 mail.example.com                     993 public          with TLS
~~~

### Import and export

Check [Import mailboxes](https://www.xmox.nl/commands/#hdr-mox-export-maildir) to import mails, i.e. for a Dovecot migration.

### Additional mail domains

Mox is able to server other domains from this server. Just create a domain in the Admin UI or with the mox CLI:
~~~bash
cd /home/mox
./mox config domain add example.org postmaster
./mox config account add holu2 hol2u@example.org
~~~

You will need to setup the DNS entries for `example.org`, which are shown in the Admin UI for this additional mail domain.

### Backup

As a *starting point* for a backup use this script

~~~bash
#!/bin/bash
MOXDIR=/home/mox
MOXBACKUPDIR=${MOXDIR}/data/tmp/backup
rm -rf ${MOXBACKUPDIR}
/home/mox/mox backup ${MOXBACKUPDIR}/data
/home/mox/mox verifydata ${MOXBACKUPDIR}/data
cp -rp ${MOXDIR}/config/ ${MOXBACKUPDIR}/config
~~~

Now backup the MOXBACKUPDIR to another server (e.g with `restic` or other backup tools).


## Conclusion

Use any of the many available mail server testing tools, such as https://internet.nl/mail/, to verify this setup and enjoy a 10/10 score.

While established mail server stacks offer a wider and robust range of features, Mox excels in its operator-friendliness. Setting up Mox securely and in accordance with best practices is significantly easier compared to traditional solutions. This reduced complexity makes Mox a good choice for a friend-and-family email server or for small businesses.



##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Robert Bill rob@slgm.ch

-->
